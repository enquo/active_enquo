[ActiveEnquo](https://enquo.org/active_enquo) is a Ruby on Rails ActiveRecord extension that works with the [pg_enquo Postgres extension](https://github.com/enquo/pg_enquo) to allow you to query encrypted data.
This allows you to keep the data you store safe, by encrypting it, without compromising on your application's ability to search for that data and work with it.

Sounds like magic?
Well, maybe a little bit.
Read our [how it works](https://enquo.org/how-it-works) if you're interested in the details, or read on for how to use it.


# Pre-requisites

In order to make use of this extension, you must be running Postgres 10 or higher, with the [`pg_enquo`](https://github.com/enquo/pg_enquo) extension enabled in the database you're working in.
See [the `pg_enquo` installation guide](https://github.com/enquo/pg_enquo/tree/main/doc/installation.md) for instructions on how to install `pg_enquo`.

Also, if you're installing this gem from source, you'll need a reasonably recent [Rust](https://rust-lang.org) toolchain installed.


# Installation

It's a gem:

    gem install active_enquo

There's also the wonders of [the Gemfile](http://bundler.io):

    gem 'active_enquo'

If you're the sturdy type that likes to run from git:

    rake install

Or, if you've eschewed the convenience of Rubygems entirely, then you
presumably know what to do already.


# Configuration

The only setting that ActiveEnquo needs is to be given a "root" key, which is used to derive the keys which are used to actually encrypt data.
This key ***MUST*** be generated by a cryptographically-secure random number generator, and must also be 64 hex digits in length.
A good way to generate this key is with the `SecureRandom` module:

```sh
ruby -r securerandom -e 'puts SecureRandom.hex(32)'
```

With this key in hand, you can store it in the Rails credential store, like this:

1. Open up the Rails credentials editor:

   ```ruby
   rails credentials:edit
   ```

2. Add a section to that file that looks like this:

   ```yaml
   active_enquo:
     root_key: "0000000000000000000000000000000000000000000000000000000000000000"
   ```

3. Save and exit the editor.  Commit the changes to your revision control system.

This only works if you are using Rails, of course; if you're using ActiveRecord by itself, you must set the root key yourself during application initialization.
You do this by assigning a `RootKey` to `ActiveEnquo.root_key`, like this:

```ruby
# DO NOT ACTUALLY PUT YOUR KEY DIRECTLY IN YOUR CODE!!!
ActiveEnquo.root_key = ActiveEnquo::RootKey::Static.new("0000000000000000000000000000000000000000000000000000000000000000")
```

However, this leaves the key exposed to anyone who comes along and takes a glance at your code.
Losing control of this root key is catastrophic for the security of your system.
Instead, you should use a secrets vault of some sort to store the key, and pass it into your initialization code somehow.

Support for cloud keystores, such as AWS KMS, GCP KMS, Azure KeyVault, and HashiCorp Vault, will be implemented sooner or later.
If you have a burning desire to see that more on the "sooner" end than "later", PRs are welcome.


# Usage

Start by creating a column in your database that uses one of the [available enquo types](https://github.com/enquo/pg_enquo/doc/data_types), with a Rails migration:

```ruby
class AddEncryptedBigintColumn < ActiveRecord::Migration[6.0]
  def change
    add_column :users, :age, :enquo_bigint
  end
end
```


## Reading and Writing

You can now use that attribute in your models as you would normally.
For example, insert a new record:

```ruby
User.create!([{name: "Clara Bloggs", username: "cbloggs", age: 42}])
```

When you retrieve a record, the value is there for you to read:

```ruby
User.where(username: "cbloggs").first.age  # => 42
```

So far, nothing more spectacular than what AR Encryption will get you.
The fun begins now...


## Querying

You can query for records with an exact age:

```ruby
User.where(age: User.enquo(:age, 42))
```

Or you can query for records with an age of less than 50:

```ruby
# This is AR's idiomatic way of saying "less-than"
User.where(age: User.enquo(:age, ...50))
```

*However*, if you examine the record in the database, it's encrypted:

```sh
psql> SELECT age FROM users WHERE username='cbloggs';
  age
-------
 {"ct":[<lots of numbers>],"ore":[<lots and LOTS of numbers>]}
```

And that, as they say, is that.


## Indexing and Ordering

To maintain [security](https://enquo.org/about/threat-models#snapshot-security), ActiveEnquo isn't able to `ORDER BY` or index columns.
This is fine for many situations -- many columns don't need indexes.

For those columns that *do* need indexes or `ORDER BY` support, you can enable support for them by setting the `enable_reduced_security_operations` flag on the attribute, like this:

```ruby
class User < ApplicationRecord
  # Enables indexing and ORDER BY for this column, at the cost of reduced security
  enquo_attr :age, enable_reduced_security_operations: true
end
```

### SECURITY ALERT

As the name implies, "reduced security operations" require that the security of the data in the column be lower than [Enquo's default security properties](https://enquo.org/about/threat-models#snapshot-security).
In particular, extra data is stored in the value which can be used by an attacker to:

* Identify all rows which have the same value for the column (although not what that value actually *is*); and

* Perform inference attacks to try and determine the approximate or exact value for the column of some or all of the rows.

The practical implications of these attack vectors varies wildly between different types of data, which makes it harder to decide if it's reasonable to allow reduced security operations.
Our recommended rule-of-thumb is that if the features you need can *only* be implemented if you either enable reduced security operations, or leave the data unencrypted, then enable them.
Otherwise, leave the default as-is.


## Saving Disk Space

While the power of `ActiveEnquo` is based around being able to *query* encrypted data, not all columns necessarily need to be queried.
If so, you can reduce the disk space requirements for those columns by setting `no_query: true` for those columns:

```ruby
class User < ApplicationRecord
  # Disables querying for this column, and saves a heap of bytes on your disk space
  enquo_attr :age, no_query: true
end
```


# Future Developments

These are some of the things that are definitely planned to be added to ActiveEnquo in the nearish future.

* **Support for key rotation**: this isn't tricky, just a bit fiddly.
  Encrypted values have a "key ID" associated with them, so we can find which values are out-of-date, but multiple keys need to useable for decryption.
  Closely related to this is **support for renaming columns**, which is problematic because keys are derived based on the column name.
  Again, key IDs (to find values encrypted with the previous column name) and the ability to attempt decryption with a key based on the previous column name sorts this out.

* **Strings**: a great deal of the sensitive data that needs protecting is in the form of strings.
  Querying strings is somewhat more involved than numeric data, and so the means of encrypting strings such that they're queryable *and* secure are more complex.
  Enquo cannot be a really useful library for supporting encrypted querying until at least some common string query operations are supported, though, so it is important that this be implemented.

* **Other data types**: while you can go a long way with strings and bigints, part of the power of SQL is the sheer variety of interesting data types it has, and the variety of things you can do with them.
  So more integer types, floats, decimals, dates, times, timestamps, and more, are all on the cards for future development.


# Contributing

For general guidelines for contributions, see [CONTRIBUTING.md](CONTRIBUTING.md).
Detailed information on developing `ActiveEnquo`, including how to run the test suite, can be found in [docs/DEVELOPMENT.md](DEVELOPMENT.md).


# Licence

Unless otherwise stated, everything in this repo is covered by the following
licence statement:

    Copyright (C) 2022  Matt Palmer <matt@enquo.org>

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in
    all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
    THE SOFTWARE.
